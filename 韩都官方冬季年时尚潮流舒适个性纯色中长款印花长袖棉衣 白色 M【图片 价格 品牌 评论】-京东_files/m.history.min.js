(function(e){!function(e){function n(){}function i(e,t){return function(){e.apply(t,arguments)}}function r(e){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],u(e,this)}function s(o,n){for(;3===o._state;)o=o._value;return 0===o._state?void o._deferreds.push(n):(o._handled=!0,void r._immediateFn(function(){var e=1===o._state?n.onFulfilled:n.onRejected;if(null===e)return void(1===o._state?a:l)(n.promise,o._value);var t;try{t=e(o._value)}catch(e){return void l(n.promise,e)}a(n.promise,t)}))}function a(t,e){try{if(e===t)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var o=e.then;if(e instanceof r)return t._state=3,t._value=e,void c(t);if("function"==typeof o)return void u(i(o,e),t)}t._state=1,t._value=e,c(t)}catch(e){l(t,e)}}function l(e,t){e._state=2,e._value=t,c(e)}function c(e){2===e._state&&0===e._deferreds.length&&r._immediateFn(function(){e._handled||r._unhandledRejectionFn(e._value)});for(var t=0,o=e._deferreds.length;t<o;t++)s(e,e._deferreds[t]);e._deferreds=null}function d(e,t,o){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=o}function u(e,t){var o=!1;try{e(function(e){o||(o=!0,a(t,e))},function(e){o||(o=!0,l(t,e))})}catch(e){if(o)return;o=!0,l(t,e)}}var t=setTimeout;r.prototype["catch"]=function(e){return this.then(null,e)},r.prototype.then=function(e,t){var o=new this.constructor(n);return s(this,new d(e,t,o)),o},r.all=function(e){var a=Array.prototype.slice.call(e);return new r(function(n,i){function r(t,e){try{if(e&&("object"==typeof e||"function"==typeof e)){var o=e.then;if("function"==typeof o)return void o.call(e,function(e){r(t,e)},i)}a[t]=e,0===--s&&n(a)}catch(e){i(e)}}if(0===a.length)return n([]);for(var s=a.length,e=0;e<a.length;e++)r(e,a[e])})},r.resolve=function(t){return t&&"object"==typeof t&&t.constructor===r?t:new r(function(e){e(t)})},r.reject=function(o){return new r(function(e,t){t(o)})},r.race=function(i){return new r(function(e,t){for(var o=0,n=i.length;o<n;o++)i[o].then(e,t)})},r._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){t(e,0)},r._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)},r._setImmediateFn=function(e){r._immediateFn=e},r._setUnhandledRejectionFn=function(e){r._unhandledRejectionFn=e},"undefined"!=typeof module&&module.exports?module.exports=r:e._Promise||(e._Promise=r)}(e);function i(){}function r(e,t){for(var o in t){e[o]=t[o]}return e}function s(e,t){for(var o in t){if(t.hasOwnProperty(o)){e[o]=t[o]}}return e}function a(e){var t={msg:"",icon:"none",delay:2e3,showcoverdiv:false},o=0;container=document.body,alertCoverDiv=document.createElement("div"),alertCoverDiv.className="mod_alert_history_mask show",e=e||{};s(t,e);var n=document.createElement("div");n.className="mod_alert_history show fixed";n.innerHTML=(t.icon!="none"?'<i class="icon'+(t.icon!="info"?" icon_"+t.icon:"")+'"></i>':"")+"<p>"+t.msg+"</p>";container.appendChild(n);if(t.showcoverdiv){document.body.appendChild(alertCoverDiv);o++}setTimeout(function(){i()},t.delay);function i(){if(t.showcoverdiv){o--;o<1&&document.body.contains(alertCoverDiv)&&document.body.removeChild(alertCoverDiv)}n.style.display="none";container.contains(n)&&container.removeChild(n)}}function t(e,t){if(!e){return}var o;if(!window["_loadCss"]||window["_loadCss"].indexOf(e)<0){o=document.createElement("link");o.setAttribute("type","text/css");o.setAttribute("rel","stylesheet");o.setAttribute("href",e);o.setAttribute("id","loadCss"+Math.random());document.getElementsByTagName("head")[0].appendChild(o);window["_loadCss"]?window["_loadCss"]+="|"+e:window["_loadCss"]="|"+e}o&&typeof t=="function"&&(o.onload=t);return true}function l(e){var t=new RegExp("(^| )"+e+"(?:=([^;]*))?(;|$)"),o=document.cookie.match(t);return o?o[2]?unescape(o[2]):"":null}function n(e,t,o,n,i,r){var s=new Date,o=arguments[2]||null,n=arguments[3]||"/",i=arguments[4]||null,r=arguments[5]||false;o?s.setMinutes(s.getMinutes()+parseInt(o)):"";document.cookie=e+"="+escape(t)+(o?";expires="+s.toGMTString():"")+(n?";path="+n:"")+(i?";domain="+i:"")+(r?";secure":"")}function c(e){var t=new Date;t.setTime(t.getTime()-1);document.cookie=e+"=; expires="+t.toGMTString()}function u(e){return e.indexOf("//")!=-1?e:"//img1"+~~(Math.random()*5)+".360buyimg.com/evalpic/s240x240_"+e}function d(e,t,o){var o=o||document.body;if(e==o){return false}if(e.hasAttribute(t)===true){return e}return d(e.parentNode,t,o)}function f(){var e=370;var t=window.innerHeight-o()-10-20-50;return t>e?e:t}function o(){return parseInt(wareHistoryConf.bottom)+40+10}function y(e){if(e==="预售"){return'<span style="fint-size: 12px">&yen;待发布</span>'}if(parseFloat(e)<0){return'<span style="fint-size: 12px">暂无报价</span>'}return"<span>&yen;</span>"+e.split(".").join("<span>.")+"</span>"}function h(e){return"//item.m.jd.com/product/"+e+".html"}function m(e){var t="";var o={3:"包邮",4:"赠品",15:"满减",18:"满赠",19:"多买优惠"};e=e.sort(function(e,t){return e-t})||[];if(e&&e.length>0){var n=e.pop();o[n]&&(t+="<span>"+o[n]+"</span>")}return t}function p(){var e=document.querySelector("#mhistory-layer__goods-con").clientHeight;var t=document.querySelector(".mhistory-layer__good")?document.querySelector(".mhistory-layer__good").clientHeight+10:100;var o=Math.ceil(e/t);var n=l("sk_history")||"";var i=n.replace(/,*(\s)*$/,"").split(",");var r=i.slice(0,o*3);r=r.concat(q);v({"report-eventid":"MFootPrintFloat_ProExpo","report-eventparam":o+"_"+r.join("#")})}function v(e){var t,o,n;if(typeof e.getAttribute==="function"){t=e.getAttribute("report-eventid")||"";o=e.getAttribute("report-eventparam")||"";n=e.getAttribute("report-eventlevel")||""}else{t=e["report-eventid"]||"";o=e["report-eventparam"]||"";n=e["report-eventlevel"]||""}if(t&&window["MPing"]){try{var i=new MPing.inputs.Click(t);i.event_param=o||"";i.event_level=n;i.updateEventSeries();var r=new MPing;r.send(i)}catch(e){console.log(e)}}}function w(r){return new _Promise(function(t,e){var o="jsonp"+Math.ceil(Math.random()*1e6);window[o]=function(e){i.removeChild(n);clearTimeout(n.timer);window[o]=null;t(e)};var n=document.createElement("script");n.src=r.url+"&callback="+o;var i=document.getElementsByTagName("head")[0];i.appendChild(n);n.onerror=function(){if(window[o]==null){e("timeout")}else{e("failed");window[o]=null;i.removeChild(n)}};if(r.timer){n.timer=setTimeout(function(){window[o]=null;i.removeChild(n)},r.timeout)}})}function _(e){var t={},o=[];for(var n=0,i=e.length;n<i;n++){if(!t[e[n]]){t[e[n]]=1;o.push(e[n])}}return o}function g(){var e=l("sk_history")||"";return e.replace(/\"/g,"").replace(/\,$/,"").split(",").slice(0,15)}function C(e){return w({url:"//yx.3.cn/service/info.action?ids="+e.join(",")})}function b(e){return w({url:"//wq.jd.com/commodity/promo/get?skuid="+e.join(",")})}function x(e){return w({url:" //pe.3.cn/prices/mgets?source=wxsq&skuids="+e.join(",")})}function H(e){var t=[];if(!e||e.length==0)return;while(e.length>0){var o=e.slice(0,20);t.push(k(o));e=e.slice(20)}return _Promise.all(t)}function k(e){return new _Promise(function(t,o){w({url:"//wq.jd.com/commodity/marattr/readattributes?sku="+e.join(",")}).then(function(e){if(e.errcode==="0"){t(e.data)}else{o(e.msg)}})})}function j(e){var t=l("sk_history")||"",o=0;t=t.replace(e+",","");q.push(e);n("sk_history",t,30*24*60,"/",".jd.com");o=t.split(",").length-1;if(o===0){c("sk_history")}return o}function E(){var e=l("regionAddress")||"";return e.length>0?e.replace(/(,|_)/g,"-"):"1-72-2819-0"}function P(e){var t='<div class="mhistory-layer" id="mhistory-layer" style="z-index: '+wareHistoryConf.zIndex+'">'+'<div id="mhistory-layer__con" class="mhistory-layer__con" style="height: '+f()+'px;padding-left: 0px;">'+'<div class="mhistory-layer__tit" style="padding-left: 10px;">我的足迹</div>'+'<div class="mhistory-layer__edit" >编辑</div>'+'<div class="mhistory-layer__close J_ping" report-eventid="MFootPrintFloat_Close"></div>'+'<div id="mhistory-wrapper"  class="mhistory-layer__goods" style="height: '+(f()-30)+'px;position: relative;overflow-y:scroll;padding-left: 10px;">'+'<div id="scroller" style="position: absolute;width: 100%;">'+'<div id="mhistory-layer__goods-con" scroller style="min-height: '+(f()-56)+'px;">';for(var o=0;o<e.length;o++){var n=e[o];t+='<a linkjump report-eventlevel="4" report-eventid="MFootPrintFloat_Pro" report-eventparam="'+o+"_"+n.skuid+'"'+'href="'+h(n.skuid)+'" class="mhistory-layer__good J_ping" data-sku="'+n.skuid+'">'+'<div class="mhistory-layer__good-pic">'+'<img src="'+u(n.imagePath)+'">'+"</div>"+'<div class="mhistory-layer__good-closebox" style="display: none;"><div report-eventid="MFootPrintFloat_ProDelete"  class="mhistory-layer__good-close J_ping"></div></div> '+'<div class="mhistory-layer__good-price">'+y(n.price.p)+"</div>"+'<div class="mhistory-layer__good-tags">'+m(n.etgs)+'</div> <div class="mhistory-layer__good-shopcar" style="display: inline-block;"><i></i></div></a>'}t+='<div style="display: none" class="mhistory-layer__empty">'+'<img class="mhistory-layer__empty-icon" src="//wq.360buyimg.com/fd/h5/wx/mhistory/images/mh-goods-empty@2x_2b18bd9d.png" alt="">'+'<div class="mhistory-layer__empty-text">还没有留下足迹哦，去逛逛吧~</div>'+'<a href="javascript:;" class="mhistory-layer__empty-btn" id="goOther">去逛逛</a>'+"</div></div>"+'<a linkjump report-eventid="MFootPrintFloat_CheckMore" href="//wqs.jd.com/wxsq_project/mhistory/index.html" class="mhistory-layer__good-more J_ping">查看更多足迹</a>'+"</div>"+"</div>"+'<div id="mhistory-layer__con-arrow" class="mhistory-layer__con-arrow" style="right: '+(parseInt(wareHistoryConf.right)+37)+'px;"></div>'+"</div></div>";var i=document.createElement("div");i.style.display="none";i.innerHTML=t;document.body.appendChild(i);return i}function M(e){this.container=P(e);this.isEditing=false;this.container.addEventListener("click",function(e){if([].slice.call(e.target.classList).indexOf("mhistory-layer__close")!==-1){this.toggle();return false}if([].slice.call(e.target.classList).indexOf("mhistory-layer__edit")!==-1){this.toggleEdit();return false}if(e.target.id==="mhistory-layer"){this.toggle();return false}if(e.target.id==="goOther"){if(JD&&JD.device.scene=="jdpingou"){location.href="//wqs.jd.com/portal/wx/tuan/pingouv3.shtml"}else{location.href="//m.jd.com"}return false}var t=e.target.parentNode.parentNode.dataset.sku;if([].slice.call(e.target.classList).indexOf("mhistory-layer__good-close")!==-1){e.preventDefault();e.stopPropagation();v(e.target);var o=j(t);e.target.parentNode.parentNode.remove();if(o<1){this.showEmpty();this.hideMoreBtn()}}var n=d(e.target,"linkjump",e.currentTarget);if(n){if(this.isEditing){e.preventDefault();e.stopPropagation();return false}if(e.target.parentNode.className=="mhistory-layer__good-shopcar"){e.preventDefault();e.stopPropagation();var i=[t,"",1,t,1,0,0];w({url:"//wq.jd.com/deal/mshopcart/addcmdy?sceneval=2&scene=2&reg=1&type=0&locationid="+E()+"&g_ty=ls&commlist="+i.join(",")+"&t="+Math.random()}).then(function(e){if(e.errId=="0"){a({msg:"加入购物车成功",icon:"success"})}else if(e.errId=="8968"){a({msg:"加入失败，购物车爆满啦",icon:"fail"})}else if(e.errId=="8969"){a({msg:"加入失败，购物车爆满啦"})}else{a({msg:"加入购物车失败",icon:"fail"})}}).catch(function(e){a({msg:"网络异常，请稍后重试",icon:"fail"})});return false}p();setTimeout(function(){location.href=n.getAttribute("href")},200)}}.bind(this))}M.prototype.toggle=function(){if(this.container.style.display=="none"){this.container.style.display="";typeof window["wareHistoryConf"].onShow==="function"&&window["wareHistoryConf"].onShow();this.scrollTop=window.pageYOffset;document.body.style.overflow="hidden";document.body.style.position="fixed";S=true;document.querySelector("#wareListBtn").style.display="none";setTimeout(function(){document.querySelector("#wareListBtn").style.display="";document.querySelector("#wareListBtn").style.top=document.querySelector("#mhistory-layer__con").getBoundingClientRect().bottom+10+"px"},100)}else{p();this.container.style.display="none";typeof window["wareHistoryConf"].onHide==="function"&&window["wareHistoryConf"].onHide();document.body.style.overflow="";document.body.style.position="";window.scrollTo(0,this.scrollTop);document.querySelector("#wareListBtn").style.top="";S=false}};M.prototype.login=function(){return l("wq_uin")&&l("wq_skey")};M.prototype.toggleEdit=function(){this.isEditing=!this.isEditing;var e=this.isEditing?"完成":"编辑",t=this.isEditing?"":"none";this.container.querySelector(".mhistory-layer__edit").innerText=e;this.container.querySelectorAll(".mhistory-layer__good-closebox").forEach(function(e){e.style.display=t})};M.prototype.hideMoreBtn=function(){this.container.querySelector(".mhistory-layer__good-more").style.display="none"};M.prototype.showEmpty=function(){this.container.querySelector(".mhistory-layer__empty").style.display=""};function T(e,t){var o=window.document.documentElement.clientHeight;var n=[];for(var i in e){n.push(e[i])}function r(){var e=/\/product\//.test(location.href)?1:0;return n[e]||n[0]}var s=false,a='<div report-eventid="MFootPrintFloat_Entrance" '+'class="mhistory-layer__btn J_ping" '+'id="wareListBtn" '+'style="display: '+(s?"":"none")+";z-index: "+wareHistoryConf.zIndex+";bottom: "+wareHistoryConf.bottom+";right: "+wareHistoryConf.right+'">'+'<img src="'+u(r().imagePath)+'">'+"</div>";var l=document.createElement("div");l.innerHTML=a;document.body.appendChild(l);btn=document.querySelector("#wareListBtn");typeof window["wareHistoryConf"].onInit==="function"&&window["wareHistoryConf"].onInit();btn.addEventListener("click",function(){t.toggle()});function c(e,t){e.tId&&clearTimeout(e.tId);e.tId=setTimeout(e,t||200)}function d(){c(function(){var e=Math.max(document.body.scrollTop,document.documentElement.scrollTop);if((e>o||S)&&F){if(btn.style.display!=="block"&&typeof window["wareHistoryConf"]["shouldButtonShow"]==="function"&&window["wareHistoryConf"]["shouldButtonShow"]()){btn.style.display="block";typeof window["wareHistoryConf"]["onButtonShow"]==="function"&&window["wareHistoryConf"]["onButtonShow"]()}}else{if(btn.style.display==="block"&&window["wareHistoryConf"]["shouldButtonHide"]()){btn.style.display="none";typeof window["wareHistoryConf"]["onButtonHide"]==="function"&&window["wareHistoryConf"]["onButtonHide"]()}}})}window.addEventListener("scroll",function(){d()})}var q=[],S=false,F=true;function I(e){if(!e)return;var t=l("sk_history")?l("sk_history").split(",").slice(0,-1):[];t.unshift(e+"");n("sk_history",_(t).join(",")+",",30*24*60,"/","jd.com")}function B(){var c="",d=[],e,t,o,n,u;window["wareHistoryConf"]=r({bottom:"120px",right:"10px",zIndex:301,shouldButtonShow:function(){return true},shouldButtonHide:function(){return true},onButtonShow:i,onButtonHide:i,onClear:i,onShow:i,onHide:i,onInit:i},window["wareHistoryConf"]||{});window["wareHistoryConf"]["skuId"]&&I(window["wareHistoryConf"]["skuId"]);c=g();if(c&&c.length>0&&c[0]){e=C(c);t=x(c);o=b(c);n=H(c);_Promise.all([e,t,o,n]).then(function(e){var t=e[0],o={},n={},i=c;e[1].forEach(function(e){o[e.id.replace("J_","")]=e});e[2].data.forEach(function(e){n[e.id]=e});e[3]&&e[3].length>0&&e[3].forEach(function(e){for(var t in e){o[t].p="预售"}});for(var r=0;r<i.length;r++){var s=o[i[r]],a=n[i[r]],l=[];a.etg!==undefined&&(l=l.concat(a.etg.split(",")));a.pis&&a.pis.forEach(function(t){if(t.pid&&t.pid.split("_")[1]==4){l.push(4)}["15","18","19"].forEach(function(e){t[e]&&l.push(e)})});d.push({skuid:i[r],imagePath:t[i[r]].imagePath,name:t[i[r]].name,size:t[i[r]].size,spec:t[i[r]].spec,color:t[i[r]].color,price:s,etgs:_(l)})}u=new M(d);T(d,u)})}}t("//wq.360buyimg.com/fd/h5/wxsq_dev/m_common/css/mhistory.min.css");window["wareHistoryConf"]["setConfig"]=function(e){if("setConfig"in e){delete e["setConfig"]}window["wareHistoryConf"]=r(window["wareHistoryConf"],e);var t=document.querySelector("#wareListBtn");$(t).css({bottom:window["wareHistoryConf"].bottom,right:window["wareHistoryConf"].right,zIndex:window["wareHistoryConf"].zIndex});$("#mhistory-layer").css({zIndex:window["wareHistoryConf"].zIndex});$("#mhistory-layer__con").css({height:f(),bottom:o()});$("#mhistory-wrapper").css({height:f()-30});$("#mhistory-layer__goods-con").css({minHeight:f()-56});$("#mhistory-layer__con-arrow").css({right:window["wareHistoryConf"].right+37})};B();e.setMhistory=I})(window);